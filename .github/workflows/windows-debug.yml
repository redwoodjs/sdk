name: Windows Debug Session

on:
  workflow_dispatch:

jobs:
  debug-session:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup VS Code Remote Tunnel
        env:
          GH_TOKEN: ${{ github.token }}
        shell: pwsh
        run: |
          # 1. Download the VS Code CLI
          $CliUri = "https://code.visualstudio.com/sha/download?build=stable&os=cli-win32-x64"
          $CliZip = "$env:TEMP\\vscode-cli.zip"
          Invoke-WebRequest -Uri $CliUri -OutFile $CliZip

          # 2. Extract it
          $CliPath = "$env:TEMP\\vscode-cli"
          Expand-Archive -Path $CliZip -DestinationPath $CliPath -Force

          # 2. Authenticate with a PAT
          $pat = gh auth token
          & "$CliPath\\code.exe" tunnel user login --provider github --access-token $pat

          # 3. Run the tunnel command.
          # This will block and keep the job alive.
          # Connect from local VS Code using the "Remote Tunnels: Connect to Tunnel" command.
          & "$CliPath\\code.exe" tunnel --accept-server-license-terms --name "rwsdk-windows-debug-${{ github.run_id }}"
