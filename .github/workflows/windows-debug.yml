name: Windows Debug Session

on:
  workflow_dispatch:
    inputs:
      reason:
        description: "Reason for starting the debug session"
        required: false
        default: "Debugging Windows path issues"

jobs:
  tunnel:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download VS Code Server
        uses: wei/curl@v1
        with:
          args: -L -o C:\vscode-server.zip https://update.code.visualstudio.com/latest/server-win32-x64/stable

      - name: Start VS Code Remote Session via serveo.net
        shell: pwsh
        run: |
          # 1. Extract the VS Code Server
          $ZipPath = "C:\\vscode-server.zip"
          $ExtractPath = "C:\\vscode-server"
          New-Item -ItemType Directory -Force -Path $ExtractPath
          Expand-Archive -Path $ZipPath -DestinationPath $ExtractPath

          # 2. Start the VS Code Server in the background on localhost:8000
          $ServerPath = "$ExtractPath\\vscode-server-win32-x64\\out\\server-main.js"
          $NodePath = "$ExtractPath\\vscode-server-win32-x64\\node.exe"
          $Args = "'$ServerPath', '--accept-server-license-terms', '--user-data-dir=$ExtractPath\\data'"

          Start-Process -FilePath $NodePath -ArgumentList $Args

          # Give the server a moment to start up
          Start-Sleep -Seconds 5

          # 3. Tunnel localhost:8000 to the internet using serveo.net
          # This command will block, keeping the workflow alive.
          # The URL for the connection will be printed in the log.
          ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=nul -R 8000:localhost:8000 serveo.net
