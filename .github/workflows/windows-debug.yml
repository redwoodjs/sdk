name: Windows Debug Session

on:
  workflow_dispatch:

jobs:
  debug-session:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download Cursor CLI (bash)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "$RUNNER_TEMP/cursor_cli"
          curl -Lk "https://api2.cursor.sh/updates/download-latest?os=cli-win32-x64" -o "$RUNNER_TEMP/cursor_cli/cursor_cli.tar.gz"

      - name: Prepare Cursor CLI for Interactive Debugging
        shell: pwsh
        run: |
          $CursorDir = "$env:RUNNER_TEMP\cursor_cli"
          $CursorArchive = "$CursorDir\cursor_cli.tar.gz"

          if (-not (Test-Path $CursorArchive)) {
            Write-Host "Cursor CLI archive not found; aborting preparation." -ForegroundColor Red
            exit 1
          }

          tar -xvf $CursorArchive -C $CursorDir | Out-Null
          $cursorExeItem = Get-ChildItem -Recurse -Path $CursorDir -Filter "cursor*.exe" | Select-Object -First 1
          if (-not $cursorExeItem) {
            $cursorExeItem = Get-ChildItem -Recurse -Path $CursorDir -Filter "cursor" | Select-Object -First 1
          }

          if ($cursorExeItem) {
            $cursorExe = $cursorExeItem.FullName
            Write-Host "Cursor CLI prepared. In tmate, start a tunnel with:" -ForegroundColor Cyan
            Write-Host "`n  & '$cursorExe' tunnel --random-name --verbose`n" -ForegroundColor Yellow
          } else {
            Write-Host "Cursor CLI executable not found after extraction." -ForegroundColor Red
          }

      - name: Start Interactive Debug Session
        uses: mxschmitt/action-tmate@v3
        # For reference, the command to run in the session:
        # & "$env:RUNNER_TEMP\cursor_cli\cursor.exe" tunnel --random-name --verbose
